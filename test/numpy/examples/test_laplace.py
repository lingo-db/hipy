
import hipy
from hipy import intrinsics
from hipy.interpreter import check_prints
from hipy.test_utils import not_constant
import hipy.lib.numpy
import numpy as np


@hipy.compiled_function
def laplace(N, Niter):
    dx = 0.1
    dy = 0.1
    dx2 = (dx * dx)
    dy2 = (dy * dy)
    u = np.zeros((N, N))
    u[0] = 1
    for i in range(Niter):
        u[1:(-1), 1:(-1)] = ((((u[2:, 1:(-1)] + u[:(-2), 1:(-1)]) * dy2) +
                              ((u[1:(-1), 2:] + u[1:(-1), :(-2)]) * dx2))
                             / (2 * (dx2 + dy2)))
    return u

@hipy.compiled_function
def fn():
    print(laplace(10, 10))


def test_laplace():
    check_prints(fn, """
[[1.00000000e+00 1.00000000e+00 1.00000000e+00 1.00000000e+00
  1.00000000e+00 1.00000000e+00 1.00000000e+00 1.00000000e+00
  1.00000000e+00 1.00000000e+00]
 [0.00000000e+00 4.44478989e-01 5.91370583e-01 6.40361786e-01
  6.55479431e-01 6.55479431e-01 6.40361786e-01 5.91370583e-01
  4.44478989e-01 0.00000000e+00]
 [0.00000000e+00 2.04997063e-01 3.12257767e-01 3.58644485e-01
  3.74057770e-01 3.74057770e-01 3.58644485e-01 3.12257767e-01
  2.04997063e-01 0.00000000e+00]
 [0.00000000e+00 8.96682739e-02 1.46556854e-01 1.73341751e-01
  1.83561325e-01 1.83561325e-01 1.73341751e-01 1.46556854e-01
  8.96682739e-02 0.00000000e+00]
 [0.00000000e+00 3.54003906e-02 5.90248108e-02 7.15522766e-02
  7.58972168e-02 7.58972168e-02 7.15522766e-02 5.90248108e-02
  3.54003906e-02 0.00000000e+00]
 [0.00000000e+00 1.17912292e-02 2.02407837e-02 2.42938995e-02
  2.59761810e-02 2.59761810e-02 2.42938995e-02 2.02407837e-02
  1.17912292e-02 0.00000000e+00]
 [0.00000000e+00 3.32546234e-03 5.52272797e-03 6.74343109e-03
  7.07721710e-03 7.07721710e-03 6.74343109e-03 5.52272797e-03
  3.32546234e-03 0.00000000e+00]
 [0.00000000e+00 7.08580017e-04 1.22261047e-03 1.40953064e-03
  1.48963928e-03 1.48963928e-03 1.40953064e-03 1.22261047e-03
  7.08580017e-04 0.00000000e+00]
 [0.00000000e+00 1.21116638e-04 1.85966492e-04 2.20298767e-04
  2.20298767e-04 2.20298767e-04 2.20298767e-04 1.85966492e-04
  1.21116638e-04 0.00000000e+00]
 [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
  0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
  0.00000000e+00 0.00000000e+00]]
      """)